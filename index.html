<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gallery PRO</title>

<style>
html,body{
  margin:0;
  background:#000;
  color:#fff;
  overflow-x:hidden;
  font-family:Arial
}

header{
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 18px
}
header img{height:72px}
header h1{font-size:18px;margin:0}

#album{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:14px;
  padding:14px;
  height:calc(100vh - 60px);
  overflow-y:auto
}

.thumb{
  background:#111;
  border-radius:8px;
  overflow:hidden;
  cursor:pointer;
  aspect-ratio:3/4;
  display:flex;
  align-items:center;
  justify-content:center
}

.thumb img{
  width:100%;
  height:100%;
  object-fit:contain;
  display:block;
  opacity:0;
  transition:opacity .3s ease
}

#viewer{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  z-index:999
}

.top-controls{
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:70px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 16px;
  z-index:20;
  pointer-events:none
}

.top-controls div{
  font-size:34px;
  color:#aaa;
  pointer-events:auto;
  cursor:pointer
}

#counter{
  position:absolute;
  top:50px;
  right:16px;
  font-size:14px;
  color:#ccc;
  z-index:20
}

#imageWrap{
  position:absolute;
  top:70px;
  left:0;
  right:0;
  bottom:120px;
  display:flex;
  justify-content:center;
  align-items:center;
  overflow:hidden;
  touch-action:none
}

#mainImage{
  max-width:100%;
  max-height:100%;
  object-fit:contain;
  transition:transform .25s ease, opacity .25s ease;
  will-change:transform;
  user-select:none;
  pointer-events:none
}

#thumbStrip{
  position:absolute;
  bottom:0;
  left:0;
  right:0;
  height:100px;
  background:rgba(0,0,0,.75);
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px;
  overflow-x:auto
}

#thumbStrip img{
  height:100%;
  opacity:.5;
  cursor:pointer;
  border-radius:4px
}

#thumbStrip img.active{
  opacity:1;
  outline:2px solid #0af
}
</style>
</head>

<body>

<header>
  <h1>Gallery PRO Engine</h1>
</header>

<div id="album"></div>

<div id="viewer">
  <div class="top-controls">
    <div id="prev">◀</div>
    <div id="close">✕</div>
    <div id="next">▶</div>
  </div>
  <div id="counter"></div>

  <div id="imageWrap">
    <img id="mainImage">
  </div>

  <div id="thumbStrip"></div>
</div>

<script>
const total = 20
const album = document.getElementById('album')
const viewer = document.getElementById('viewer')
const img = document.getElementById('mainImage')
const counter = document.getElementById('counter')
const strip = document.getElementById('thumbStrip')

let index = 0
let scale = 1
let x = 0
let y = 0
let anim = false
let isPinching = false
let drag = false
let startX = 0
let startY = 0
let lastUpdate = 0

const preloadCache = new Set()

function createThumb(i){
  const n = String(i+1).padStart(2,'0')
  const d = document.createElement('div')
  d.className = 'thumb'

  const im = document.createElement('img')
  im.dataset.src = `thumbs/${n}.jpg`

  d.appendChild(im)
  d.onclick = ()=>open(i)
  album.appendChild(d)

  io.observe(im)

  const t = document.createElement('img')
  t.loading = 'lazy'
  t.src = `thumbs/${n}.jpg`
  t.onclick = ()=>jump(i)
  strip.appendChild(t)
}

for(let i=0;i<total;i++) createThumb(i)

const io = new IntersectionObserver(entries=>{
  entries.forEach(e=>{
    if(e.isIntersecting){
      const im = e.target
      im.src = im.dataset.src
      im.onload = ()=> im.style.opacity = 1
      io.unobserve(im)
    }
  })
},{root:album, rootMargin:'200px'})

function preload(i){
  [-1,1].forEach(o=>{
    const n = i+o
    if(n>=0 && n<total){
      if(preloadCache.has(n)) return
      const im = new Image()
      im.src = `medium/${String(n+1).padStart(2,'0')}.jpg`
      preloadCache.add(n)
    }
  })
}

function open(i){
  index = i
  viewer.style.display='block'
  document.body.style.overflow='hidden'
  reset()
  load()
}

function close(){
  viewer.style.display='none'
  document.body.style.overflow='auto'
}

function load(){
  img.style.opacity = 0
  const n = String(index+1).padStart(2,'0')
  img.src = `medium/${n}.jpg`
  counter.textContent = `${index+1}/${total}`
  setActive()
  preload(index)
  requestAnimationFrame(()=>img.style.opacity = 1)
}

function slide(d){
  if(anim || scale!==1 || isPinching) return
  anim = true
  setTimeout(()=>{
    index = (index + d + total) % total
    reset()
    load()
    anim = false
  },200)
}

function setActive(){
  [...strip.children].forEach((t,i)=>{
    t.classList.toggle('active',i===index)
  })
}

function jump(i){
  index=i
  reset()
  load()
}

function reset(){
  scale=1
  x=0
  y=0
  update()
}

function update(){
  const now = performance.now()
  if(now - lastUpdate < 16) return
  lastUpdate = now
  img.style.transform = `translate(${x}px,${y}px) scale(${scale})`
}

viewer.addEventListener('wheel',e=>{
  e.preventDefault()
  const delta = e.deltaY < 0 ? 0.1 : -0.1
  scale += delta
  scale = Math.max(1,Math.min(scale,4))
  update()
},{passive:false})

viewer.addEventListener('dblclick',()=>{
  if(scale===1) scale=2
  else { scale=1; x=0; y=0 }
  update()
})

document.getElementById('prev').onclick=()=>slide(-1)
document.getElementById('next').onclick=()=>slide(1)
document.getElementById('close').onclick=close
</script>

</body>
</html>
